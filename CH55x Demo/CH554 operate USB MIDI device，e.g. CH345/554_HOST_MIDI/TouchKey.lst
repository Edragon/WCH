C51 COMPILER V9.53.0.0   TOUCHKEY                                                          12/20/2017 09:10:26 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE TOUCHKEY
OBJECT MODULE PLACED IN TouchKey.obj
COMPILER INVOKED BY: D:\Keil\Install\C51\BIN\C51.EXE TouchKey\TouchKey.C LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTE
                    -ND PRINT(.\TouchKey.lst) OBJECT(TouchKey.obj)

line level    source

   1          
   2          /********************************** (C) COPYRIGHT *******************************
   3          * File Name          : TouchKey.C
   4          * Author             : WCH
   5          * Version            : V1.0
   6          * Date               : 2017/01/20
   7          * Description        : CH554 ´¥Ãþ°´¼ü²ÉÑù¼ä¸ôÉèÖÃ¡¢Í¨µÀÑ¡ÔñºÍÇÐ»»ºÍÖÐ¶Ï´¦Àíº¯Êý   
   8          *******************************************************************************/
   9          
  10          #include "..\Public\CH554.H"                                                       
  11          #include "..\Public\Debug.H"
  12          #include "TouchKey.H"
  13          #include "stdio.h"
  14          
  15          #pragma  NOAREGS
  16          
  17          UINT16  KeyFree[KEY_LAST-KEY_FIRST+1];                                        //´¥Ãþ¿ÕÏÐÖµ´æ´¢£¬ÓÃÓÚ±È½Ï°´¼
             -ü×´Ì¬£¬Èç¹û²ÉÑùÖµÐ¡ÓÚ»ù×¼Öµ±íÃ÷°´¼ü°´ÏÂ
  18          UINT8V  KeyBuf;                                                               //´¥Ãþ°´¼ü×´Ì¬£¬Îª0±íÊ¾ÎÞ°´¼ü
             -£¬·Ç0±íÊ¾µ±Ç°¼ì²â°´¼ü±»°´ÏÂ
  19          
  20          /*******************************************************************************
  21          * Function Name  : GetTouckKeyFreeBuf()
  22          * Description    : »ñÈ¡´¥Ãþ°´¼ü¿Õ¼ä×´Ì¬¼üÖµ
  23          * Input          : None                                                          
  24          * Output         : None
  25          * Return         : None
  26          *******************************************************************************/
  27          void GetTouckKeyFreeBuf()
  28          {
  29   1        UINT8 i,j;
  30   1        UINT8 TmpSum = 0;
  31   1        KeyBuf = 0;                                                                 //³õÊ¼»¯ÉèÖÃÎªÎÞ°´¼ü×´Ì¬
  32   1        for(i=KEY_FIRST;i<(KEY_LAST+1);i++)
  33   1        {
  34   2                      j = KEY_BASE_SAMPLE_TIME;                                                 //²É¶à´ÎÇóÆ½¾ùÖµ×÷Îª²ÉÑù²Î¿¼
  35   2                TKEY_CTRL = (TKEY_CTRL & 0xF8 | i)+1;                                     //ÉèÖÃ²ÉÑùÍ¨µÀ
  36   2          while(j--)
  37   2          {
  38   3              while((TKEY_CTRL&bTKC_IF) == 0);                                      //bTKC_IF±äÎª1Ê±£¬±¾ÖÜÆÚ²ÉÑù
             -Íê³É
  39   3              TmpSum += TKEY_DAT&0x0F;                                              //²ÉÑùÖµÎÈ¶¨£¬È¡µÍ4Î»¾Í¹»ÁË
  40   3          }           
  41   2          KeyFree[i] = TKEY_DAT&0x07F0 + TmpSum/5;                                  //±£´æ²ÉÑùÖµ 
  42   2        }
  43   1      #if INTERRUPT_TouchKey
                  IE_TKEY = 1;                                                              //Ê¹ÄÜTouch_KeyÖÐ¶Ï
              #endif   
  46   1      }
  47          
  48          /*******************************************************************************
  49          * Function Name  : TouchKeyChannelSelect(UINT8 ch)
  50          * Description    : ´¥Ãþ°´¼üÍ¨µÀÑ¡Ôñ
  51          * Input          : UINT8 ch ²ÉÓÃÍ¨µÀ
C51 COMPILER V9.53.0.0   TOUCHKEY                                                          12/20/2017 09:10:26 PAGE 2   

  52                             0~5 ·Ö±ð´ú±í²ÉÑùÍ¨µÀ
  53          * Output         : None
  54          * Return         : ³É¹¦ SUCCESS
  55                             Ê§°Ü FAIL  ²»Ö§³ÖµÄÍ¨µÀ
  56          *******************************************************************************/
  57          UINT8 TouchKeyChannelSelect(UINT8 ch)
  58          {
  59   1          if(ch < 6)
  60   1          {
  61   2              TKEY_CTRL = (TKEY_CTRL & 0xF8 | ch)+1;
  62   2              return SUCCESS;                 
  63   2          }
  64   1          return FAIL;
  65   1      }
  66          
  67          #if INTERRUPT_TouchKey
              /*******************************************************************************
              * Function Name  : TouchKeyInterrupt(void)
              * Description    : Touch_Key ÖÐ¶Ï·þÎñ³ÌÐò
              *******************************************************************************/
              void    TouchKeyInterrupt( void ) interrupt INT_NO_TKEY using 1                //Touch_KeyÖÐ¶Ï·þÎñ³ÌÐò,Ê¹ÓÃ¼Ä
             -´æÆ÷×é1
              { 
                        UINT8 ch;
                  UINT16 KeyData;
              
                  KeyData = TKEY_DAT;                                                       //±£³Ö87us,¾¡¿ìÈ¡×ß
                  ch = TKEY_CTRL&7;                                                         //»ñÈ¡µ±Ç°²ÉÑùÍ¨µÀ
                  if ( ch > KEY_LAST ){
                     TKEY_CTRL = TKEY_CTRL & 0xF8 | KEY_FIRST;                              //´ÓÊ×Í¨µÀ¿ªÊ¼²ÉÑù
                  }                   
                  else
                  {
                     TKEY_CTRL ++;                                                          //ÇÐ»»ÖÁÏÂÒ»¸ö²ÉÑùÍ¨µÀ
                  }
                  if ( KeyData < (KeyFree[ch-KEY_FIRST] - KEY_ACT) )                        //ÈçÌõ¼þÂú×ã£¬´ú±í°´¼ü°´ÏÂ  
             - 
                  {
                      KeyBuf=ch;                                                            //¿ÉÒÔÔÚ´Ë´¦½øÐÐ°´¼ü¶¯×÷´¦Àí
             -»òÕßÖÃ±êÖ¾Í¨Öªmain½øÐÐ´¦Àí
                  }
              }
              #else
  92          /*******************************************************************************
  93          * Function Name  : TouchKeyChannelQuery()
  94          * Description    : ´¥Ãþ°´¼üÍ¨µÀ×´Ì¬²éÑ¯
  95          * Input          : None
  96          * Output         : None
  97          * Return         : None
  98          *******************************************************************************/
  99          void TouchKeyChannelQuery()
 100          {
 101   1                UINT8 ch;
 102   1          UINT16 KeyData;
 103   1      
 104   1          while((TKEY_CTRL&bTKC_IF) == 0);                                          //bTKC_IF±äÎª1Ê±£¬±¾ÖÜÆÚ²ÉÑù
             -Íê³É
 105   1          KeyData = TKEY_DAT;                                                       //±£³Ö87us,¾¡¿ìÈ¡×ß
 106   1          ch = TKEY_CTRL&7;                                                         //»ñÈ¡µ±Ç°²ÉÑùÍ¨µÀ
 107   1          if ( ch > KEY_LAST ){
 108   2             TKEY_CTRL = TKEY_CTRL & 0xF8 | KEY_FIRST;                              //´ÓÊ×Í¨µÀ¿ªÊ¼²ÉÑù
 109   2          }                   
C51 COMPILER V9.53.0.0   TOUCHKEY                                                          12/20/2017 09:10:26 PAGE 3   

 110   1          else
 111   1          {
 112   2             TKEY_CTRL ++;                                                          //ÇÐ»»ÖÁÏÂÒ»¸ö²ÉÑùÍ¨µÀ
 113   2          }
 114   1          if ( KeyData < (KeyFree[ch-KEY_FIRST] - KEY_ACT) )                        //ÈçÌõ¼þÂú×ã£¬´ú±í°´¼ü°´ÏÂ  
             - 
 115   1          {
 116   2              KeyBuf=ch;                                                            //¿ÉÒÔÔÚ´Ë´¦½øÐÐ°´¼ü¶¯×÷´¦Àí
             -»òÕßÖÃ±êÖ¾Í¨Öªmain½øÐÐ´¦Àí
 117   2          }
 118   1      }
 119          #endif
 120          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    164    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      9    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
